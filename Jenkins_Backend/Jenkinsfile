pipeline {
    agent any
    options {
        buildDiscarder(logRotator(numToKeepStr: '4'))
    }

    environment {
        DOCKER_IMAGE = 'backend_image'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        GITHUB_REPO_URL = 'https://github.com/RazSherf/Stocker---App'
        GITHUB_DEPLOYMENT_REPO = 'https://github.com/RazSherf/Stocker---DevOps'
        AWS_REGION = 'us-east-1'
        ECR_REPO_URI = '471112618713.dkr.ecr.us-east-1.amazonaws.com/backend_repo'
        EC2_HOST = 'ec2-user@18.213.94.237'
        GITHUB_CREDS = credentials('github-credentials')
    }

    stages {
        stage('Checkout App') {
            steps {
                git branch: 'main', 
                    url: "${GITHUB_REPO_URL}",
                    credentialsId: 'github-credentials'
            }
        }

        stage('Detect Changes') {
            steps {
                script {
                    def backendChanged = sh(
                        script: "git diff --name-only HEAD^..HEAD | grep -qE '^backend/'",
                        returnStatus: true
                    ) == 0

                    if (!backendChanged) {
                        currentBuild.result = 'ABORTED'
                        currentBuild.rawBuild.keepLog(false)
                        echo "No relevant changes detected in the backend directory. Aborting pipeline."
                        error("No changes detected in the backend directory.")
                    }
                }
            }
        }

        stage('Build and Push Image') {
            steps {
                script {
                    // Clean old images
                    sh "docker rmi -f ${DOCKER_IMAGE}:${DOCKER_TAG} || true"
                    
                    // Build new image
                    echo "Building Docker image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}", "-f backend/Dockerfile backend")
                    
                    // Push to ECR
                    sh """
                        aws ecr get-login-password --region ${AWS_REGION} | \
                        docker login --username AWS --password-stdin ${ECR_REPO_URI}
                        
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${ECR_REPO_URI}:${DOCKER_TAG}
                        docker push ${ECR_REPO_URI}:${DOCKER_TAG}
                    """
                }
            }
        }

        stage('Update Deployment File') {
            steps {
                dir('k8s-config') {
                    // Checkout the deployment repository
                    git branch: 'main',
                        url: "${GITHUB_DEPLOYMENT_REPO}",
                        credentialsId: 'github-credentials'
                    
                    withCredentials([usernamePassword(credentialsId: 'github-credentials', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')]) {
                        sh '''
                            # Show current image tag
                            echo "Current deployment file content:"
                            cat Kubernetes/deployments/backend-deployment.yaml
                            
                            # Update image tag in deployment file
                            sed -i "s|${ECR_REPO_URI}:[0-9]*|${ECR_REPO_URI}:${DOCKER_TAG}|g" Kubernetes/deployments/backend-deployment.yaml
                            
                            # Show updated content
                            echo "Updated deployment file content:"
                            cat Kubernetes/deployments/backend-deployment.yaml
                            
                            # Configure git
                            git config user.email "jenkins@example.com"
                            git config user.name "Jenkins"
                            
                            # Force add and commit changes
                            git add -f Kubernetes/deployments/backend-deployment.yaml
                            git diff --cached --exit-code || git commit -m "Update backend deployment to version ${DOCKER_TAG}"
                            
                            # Use credentials safely and force push
                            git remote set-url origin "https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/RazSherf/Stocker---DevOps.git"
                            git push origin main
                        '''
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            environment {
                SSH_KEY = credentials('ec2-ssh-key')
            }
            steps {
                script {
                    try {
                        sh """
                            chmod 400 \${SSH_KEY}
                            ssh -o StrictHostKeyChecking=no -i \${SSH_KEY} \${EC2_HOST} '
                                # Pull latest deployment configurations
                                cd /home/ec2-user/Stocker---DevOps
                                git config pull.rebase false
                                git fetch origin main
                                git reset --hard origin/main
                                
                                # Pull new image from ECR
                                aws ecr get-login-password --region ${AWS_REGION} | \
                                docker login --username AWS --password-stdin ${ECR_REPO_URI}
                                docker pull ${ECR_REPO_URI}:${DOCKER_TAG}
                                
                                # Apply the deployment
                                kubectl apply -f Kubernetes/deployments/backend-deployment.yaml
                                kubectl rollout status deployment/backend
                            '
                        """
                    } catch (Exception e) {
                        error "Failed to deploy to Kubernetes: ${e.getMessage()}"
                    }
                }
            }
        }

        stage('Cleanup Old Images') {
            environment {
                SSH_KEY = credentials('ec2-ssh-key')
            }
            steps {
                script {
                    try {
                        sh """
                            chmod 400 \${SSH_KEY}
                            ssh -o StrictHostKeyChecking=no -i \${SSH_KEY} \${EC2_HOST} '
                                echo "Cleaning up old Docker images..."
                                OLD_TAGS=\$(docker images ${ECR_REPO_URI} --format "{{.Tag}}" | sort -n | head -n -2)
                                
                                if [ ! -z "\${OLD_TAGS}" ]; then
                                    for tag in \${OLD_TAGS}; do
                                        echo "Removing image: ${ECR_REPO_URI}:\${tag}"
                                        docker rmi ${ECR_REPO_URI}:\${tag} || true
                                    done
                                fi
                            '
                        """
                    } catch (Exception e) {
                        echo "Warning: Image cleanup encountered an issue: ${e.getMessage()}"
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully! New version deployed to Kubernetes.'
        }
        failure {
            echo 'Pipeline failed. Check the logs for details.'
        }
        aborted {
            echo 'Pipeline was aborted because no relevant changes were detected.'
        }
        always {
            cleanWs()
        }
    }
}